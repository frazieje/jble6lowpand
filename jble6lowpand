#! /bin/sh
#  /etc/init.d/jble6lowpand

### BEGIN INIT INFO
# Provides:          jble6lowpand
# Required-Start:    $remote_fs $syslog
# Required-Stop:     $remote_fs $syslog
# Short-Description: Starts the Bluetooth 6Lowpan service
# Description:       This file is used to start the daemon
#                    and should be placed in /etc/init.d
### END INIT INFO

# Author:   Joel Frazier <frazieje@gmail.com>
# Date:     11/02/2017

NAME="jble6lowpand"
DESC="Bluetooth 6Lowpan connector service"

# The path to the folder of the repository
FILE_PATH="/usr/local/$NAME"

# The path to Jsvc
EXEC="/usr/bin/jsvc"

# The path to the folder containing the java runtime
JAVA_HOME="/usr/lib/jvm/jdk-8-oracle-arm32-vfp-hflt"

# The path to the java executable
CLI_EXEC="$JAVA_HOME/bin/java"

# The path to the jar file
JAR_PATH="$FILE_PATH/build/libs/jble6lowpand-0.1.jar"

# The path to the logging framework to be linked for the daemon via slf4j
LOG_CLASS_PATH="$FILE_PATH/build/output/libs/logback-classic-1.2.3.jar:$FILE_PATH/build/output/libs/logback-core-1.2.3.jar"

# The path to the logging framework to be linked for the cli via slf4j
CLI_LOG_CLASS_PATH="$FILE_PATH/build/output/libs/slf4j-simple-1.7.25.jar"

# Cli classpath
CLI_CLASS_PATH="$JAR_PATH:$FILE_PATH/build/output/libs/commons-daemon-1.0.15.jar:$FILE_PATH/build/output/libs/slf4j-api-1.7.25.jar:$CLI_LOG_CLASS_PATH"

# Our classpath including our jar file
CLASS_PATH="$JAR_PATH:$FILE_PATH/build/output/libs/commons-daemon-1.0.15.jar:$FILE_PATH/build/output/libs/slf4j-api-1.7.25.jar:$LOG_CLASS_PATH"

# The fully qualified name of the class to execute
CLASS="com.spoohapps.jble6lowpand.ScanningDaemon"

# The fully qualified name of the cli class
CLI_CLASS="com.spoohapps.jble6lowpand.controller.Ble6LowpanDaemonController"

# library path for jni
LOADLIB="$FILE_PATH/jni/libs/arm32"

# Any command line arguments to be passed to the our Java Daemon implementations init() method 
ARGS="-d 3000 -t 2000 -c 1000 -w $FILE_PATH/knowndevices.conf"

# The file that will contain our process identification number (pid) for other scripts/programs that need to access it.
PID="/var/run/$NAME.pid"

# System.out writes to this file...
LOG_OUT="$FILE_PATH/log/$NAME.out"

# System.err writes to this file...
LOG_ERR="$FILE_PATH/err/$NAME.err"

jsvc_exec()
{   
    cd $FILE_PATH
    hciconfig hci0 reset
    sleep 1
    $EXEC -home $JAVA_HOME -cp $CLASS_PATH -Djava.library.path=$LOADLIB -outfile $LOG_OUT -errfile $LOG_ERR -pidfile $PID $1 $CLASS $ARGS
}

cli_exec()
{
    cd $FILE_PATH
    $CLI_EXEC -cp $CLI_CLASS_PATH $CLI_CLASS $1
}

case "$1" in
    start)  
        echo "Starting the $DESC..."        

        # Start the service
        jsvc_exec
        
        echo "The $DESC has started."
    ;;
    stop)
        echo "Stopping the $DESC..."

        # Stop the service
        jsvc_exec "-stop"       
        
        echo "The $DESC has stopped."
    ;;
    restart)
        if [ -f "$PID" ]; then
            
            echo "Restarting the $DESC..."
            
            # Stop the service
            jsvc_exec "-stop"
            
            # Start the service
            jsvc_exec
            
            echo "The $DESC has restarted."
        else
            echo "Daemon not running, no action taken"
            exit 1
        fi
            ;;
    list)
       if [ -f "$PID" ]; then
            echo "List connected devices..."
            cli_exec "-list"
       else
            echo "jble6lowpand not running"
       fi
    ;;
    known)
       if [ -f "$PID" ]; then
            echo "List known devices..."
            cli_exec "-known"
       else
            echo "jble6lowpand not running"
       fi
    ;;
    *)
    echo "Usage: /etc/init.d/$NAME {start|stop|restart}" >&2
    exit 3
    ;;
esac
